var ProjectFirmaMaps={},highlightOverlay,mapOutsideScope;ProjectFirmaMaps.Map=function(n,t,i,r){var s=this,h,v,e,u,o,l;this.MapDivId=n.MapDivID;this.ProjectDetailedLocationSelectedLayerUrl=r;var y=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{}),p=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{}),w=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{}),a=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",{}),c={Aerial:y,Street:p,Terrain:w},f={};i||(f={"Street Labels":a});t==="Hybrid"?(h=new L.LayerGroup,t="Aerial",a.addTo(h)):(Sitka.Methods.isUndefinedNullOrEmpty(t)||c[t]==null)&&(t="Terrain");v={scrollWheelZoom:!1,layers:[c[t]],attributionControl:!1,fullscreenControl:n.AllowFullScreen?{pseudoFullscreen:!0}:!1};this.map=L.map(this.MapDivId,v);mapOutsideScope=this.map;this.map.on("overlayremove",function(n){highlightOverlay&&n.name.includes("All Project Locations - Detail")&&highlightOverlay.remove()});if(h!=null&&h.addTo(this.map),this.vectorLayers=[],!i){for(u=0;u<n.ExternalMapLayers.length;++u)e=n.ExternalMapLayers[u],e.IsTiledMapService&&this.addTiledLayerFromAGOL(e,f);for(u=0;u<n.ExternalMapLayers.length;++u)e=n.ExternalMapLayers[u],e.IsTiledMapService||this.addVectorLayerFromAGOL(e,f)}for(u=0;u<n.Layers.length;++u){o=n.Layers[u];switch(o.LayerType){case"Vector":this.addVectorLayer(o,f);break;case"Wms":this.addWmsLayer(o,f);break;default:console.error("Invalid LayerType "+o.LayerType+" not added to map layers.")}}if(this.addLayersToMapLayersControl(c,f,i),l=jQuery(".modal"),!Sitka.Methods.isUndefinedNullOrEmpty(l))l.on("shown.bs.modal",function(){s.map.invalidateSize();s.setMapBounds(n)});if(!n.DisablePopups)this.map.on("click",function(n){s.getFeatureInfo(n)});s.setMapBounds(n)};ProjectFirmaMaps.Map.prototype.addTiledLayerFromAGOL=function(n,t){var i=L.esri.tiledMapLayer({url:n.LayerUrl});t[n.DisplayName]=i;n.LayerIsOnByDefault&&i.addTo(this.map)};ProjectFirmaMaps.Map.prototype.addVectorLayerFromAGOL=function(n,t){var i=L.esri.featureLayer({url:n.LayerUrl});n.FeatureNameField&&i.bindPopup(function(t){var i=this.getLatLng();return t.feature.properties[n.FeatureNameField]?L.Util.template("<strong>"+n.DisplayName+": <\/strong> {"+n.FeatureNameField+"}<br ><strong>Location: <\/strong>"+i.lat.toFixed(4)+", "+i.lng.toFixed(4),t.feature.properties):L.Util.template('<div class="alert alert-danger">The configured Feature Name was not found.',t.feature.properties)});t[n.DisplayName]=i;n.LayerIsOnByDefault&&i.addTo(this.map)};ProjectFirmaMaps.Map.prototype.addVectorLayer=function(n,t){var r=this,i=new L.LayerGroup,u=L.geoJson(n.GeoJsonFeatureCollection,{pointToLayer:function(t,i){var r=t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor;return L.marker(i,{icon:L.MakiMarkers.icon({icon:"marker",color:r,size:"s"})})},style:function(t){var i=_.includes(["Polygon","MultiPolygon"],t.geometry.type);return{color:t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor,weight:t.properties.FeatureWeight==null?2:t.properties.FeatureWeight,fill:t.properties.FillPolygon==null?i:t.properties.FillPolygon,fillOpacity:t.properties.FillOpacity==null?.2:t.properties.FillOpacity}},onEachFeature:function(n,t){r.bindPopupToFeature(t,n);r.bindHoverToFeature(t,n)}}).addTo(i);n.LayerInitialVisibility===1&&i.addTo(this.map);n.LayerIconImageLocation!=undefined&&n.LayerIconImageLocation!=null&&n.LayerIconImageLocation!=""?t['<img src="'+n.LayerIconImageLocation+'" />'+n.LayerName]=i:t[n.LayerName]=i;this.vectorLayers.push(u)};ProjectFirmaMaps.Map.prototype.addWmsLayer=function(n,t){var i=new L.LayerGroup,u,r;u=n.HasCqlFilter?L.Util.extend(this.wmsParams,{layers:n.MapServerLayerName,cql_filter:n.CqlFilter}):L.Util.extend(this.wmsParams,{layers:n.MapServerLayerName,cql_filter:"1=1"});r=L.tileLayer.wms(n.MapServerUrl,u).addTo(i);n.ContextObjectId&&(r.ContextObjectId=n.ContextObjectId);n.LayerInitialVisibility===1&&i.addTo(this.map);r.on("click",function(n){self.getFeatureInfo(n)});n.LayerIconImageLocation!=undefined&&n.LayerIconImageLocation!=null&&n.LayerIconImageLocation!=""?t['<img src="'+n.LayerIconImageLocation+'" />'+n.LayerName]=i:t[n.LayerName]=i;this.vectorLayers.push(r)};ProjectFirmaMaps.Map.prototype.wmsParams={service:"WMS",transparent:!0,version:"1.1.1",format:"image/png",info_format:"application/json",tiled:!0};ProjectFirmaMaps.Map.prototype.wfsParams={service:"WFS",version:"2.0",request:"GetFeature",outputFormat:"application/json",SrsName:"EPSG:4326"};ProjectFirmaMaps.Map.prototype.addLayersToMapLayersControl=function(n,t,i){if(i){var r={"Find Your Forester":t};this.layerControl=L.control.groupedLayers(n,r,{exclusiveGroups:["Find Your Forester"],groupCheckboxes:!0});this.layerControl.addTo(this.map)}else this.layerControl=L.control.layers(n,t),this.layerControl.addTo(this.map)};ProjectFirmaMaps.Map.prototype.setMapBounds=function(n){this.map.fitBounds([[n.BoundingBox.Northeast.Latitude,n.BoundingBox.Northeast.Longitude],[n.BoundingBox.Southwest.Latitude,n.BoundingBox.Southwest.Longitude]])};ProjectFirmaMaps.Map.prototype.bindPopupToFeature=function(n,t){var i=this;if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties.PopupUrl)){n.bindPopup("Loading...");n.on("click",function(r){var u=r.target instanceof L.Marker,f=u?r.target.getLatLng():r.latlng;i.map.setView(f);jQuery.get(t.properties.PopupUrl).done(function(t){n.bindPopup(t).openPopup()})})}};ProjectFirmaMaps.Map.prototype.bindHoverToFeature=function(n,t){if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties["Hover Name"])){n.bindTooltip(t.properties["Hover Name"],{direction:"auto",sticky:"true"});var i=n.options.fillOpacity;n.on("mouseover",function(){n.setStyle({fillOpacity:Math.min(i+.4,1)})});n.on("mouseout",function(){n.setStyle({fillOpacity:i})})}return n};ProjectFirmaMaps.Map.prototype.assignClickEventHandler=function(n){for(var r,i=this,t=0;t<this.vectorLayers.length;++t){r=this.vectorLayers[t];r.on("click",function(t){n(i,t)})}this.map.on("click",function(t){n(i,t)})};ProjectFirmaMaps.Map.prototype.removeClickEventHandler=function(){for(var t,n=0;n<this.vectorLayers.length;++n)t=this.vectorLayers[n],t.off("click");this.map.off("click")};ProjectFirmaMaps.Map.prototype.formatLayerProperty=function(n,t){return Sitka.Methods.isUndefinedNullOrEmpty(t)&&(t="&nbsp"),"<span><strong>"+n+":<\/strong> "+t+"<\/span><\/br>"};ProjectFirmaMaps.Map.prototype.removeLayerFromMap=function(n){Sitka.Methods.isUndefinedNullOrEmpty(n)||this.map.removeLayer(n)};ProjectFirmaMaps.Map.prototype.addLayerToLayerControl=function(n,t){this.layerControl.addOverlay(n,t)};ProjectFirmaMaps.Map.prototype.disableUserInteraction=function(){this.map.dragging.disable();this.map.touchZoom.disable();this.map.doubleClickZoom.disable();this.map.scrollWheelZoom.disable();this.map.boxZoom.disable();this.map.keyboard.disable();this.map.attributionControl=!1;this.map.tap&&this.map.tap.disable();document.getElementById(this.MapDivId).style.cursor="default";jQuery(".leaflet-control-zoom").css("visibility","hidden");jQuery(".leaflet-control-layers").css("visibility","hidden");this.removeClickEventHandler()};ProjectFirmaMaps.Map.prototype.blockMapImpl=function(){this.map.dragging.disable();this.map.scrollWheelZoom.disable();jQuery("#"+this.MapDivId).block({message:"<span style='font-weight: bold; font-size: 14px; margin: 0 2px'>Location Not Specified<\/span>",css:{border:"none",cursor:"default"},overlayCSS:{backgroundColor:"#D3D3D3",cursor:"default"},baseZ:999})};ProjectFirmaMaps.Map.prototype.blockMap=function(){var t=this,n;this.blockMapImpl();n=jQuery(".modal");n.on("shown.bs.modal",function(){t.blockMapImpl()})};ProjectFirmaMaps.Map.prototype.unblockMap=function(){this.map.dragging.enable();jQuery("#"+this.MapDivId).unblock()};ProjectFirmaMaps.Map.prototype.getWmsLayers=function(n){var t=this;return this.vectorLayers.filter(function(i){return i.hasOwnProperty("wmsParams")&&(!n||t.map.hasLayer(i))})};ProjectFirmaMaps.Map.prototype.getVectorLayers=function(n){var t=this;return this.vectorLayers.filter(function(i){return!i.hasOwnProperty("wmsParams")&&(!n||t.map.hasLayer(i))})};ProjectFirmaMaps.Map.prototype.getFeatureInfo=function(n){var t=n.latlng,u=this,i=this.getWmsLayers(!0),r=this.getVectorLayers(!0);highlightOverlay&&highlightOverlay.remove();i.length>0?this.popupForWMSAndVectorLayers(i,r,t):this.popupForVectorLayers(r,t)};ProjectFirmaMaps.Map.prototype.popupForVectorLayers=function(n,t){for(var u,f,e,o,i=[],r=0;r<n.length;++r)u=n[r],f=this.getVectorLayerInfoHtmlForPopup(u,t),i.push(f);e=L.Util.formatNum(t.lat,4);o=L.Util.formatNum(t.lng,4);i.push({label:"Location",link:e+", "+o});this.map.setView(t);jQuery("#findYourForesterContainer")||this.map.openPopup(L.popup({maxWidth:200}).setLatLng(t).setContent(this.htmlPopupContents(i)).openOn(this.map))};ProjectFirmaMaps.Map.prototype.htmlPopupContents=function(n){var i=this,r=this.removeDuplicatesFromArray(n,"label"),t="<div>";return _.forEach(r,function(n){n.label!=null&&(t+=i.formatLayerProperty(n.label,n.link))}),t+="<\/div>"};ProjectFirmaMaps.Map.prototype.getVectorLayerInfoHtmlForPopup=function(n,t){for(var i,u=null,f=null,e=leafletPip.pointInLayer(t,n,!0),o=_(e).map(function(n){return _.keys(n.feature.properties)}).flatten().uniq().map(function(n){return{key:n,values:_(e).map(function(t){return t.feature.properties[n]}).filter().value()}}).value(),r=0;r<o.length;r++)i=o[r],i.key!=="Hover Name"&&(u=i.values.length>1?i.key+"s":i.key,f=i.values.join(", "));return{label:u,link:f}};ProjectFirmaMaps.Map.prototype.popupForWMSAndVectorLayers=function(n,t,i){var u=this,o=this.map.latLngToContainerPoint(i,this.map.getZoom()),s=this.map.getSize(),f={service:"WMS",version:"1.1.1",request:"GetFeatureInfo",layers:null,styles:"",srs:"EPSG:4326",bbox:this.map.getBounds().toBBoxString(),height:s.y,width:s.x,query_layers:null,info_format:"application/json"},e,r,h,c;for(f.x=o.x,f.y=o.y,e=[],r=0;r<n.length;++r)h=n[r],f.layers=n[r].wmsParams.layers,f.query_layers=n[r].wmsParams.layers,n[r].wmsParams.cql_filter&&(f.cql_filter=n[r].wmsParams.cql_filter),c=h._url,e.push(jQuery.when(jQuery.ajax({url:c,type:"POST",data:L.Util.getParamString(f,null,!0)})).then(function(n){return u.formatGeospatialAreaResponse(n).then(function(n){return n})}));return this.carryOutPromises(e).then(function(n){for(var e,o,s,h,r=[],f=0;f<t.length;++f)e=t[f],o=u.getVectorLayerInfoHtmlForPopup(e,i),r.push(o);_.forEach(n,function(n){n!=null&&r.push(n)});s=L.Util.formatNum(i.lat,4);h=L.Util.formatNum(i.lng,4);r.push({label:"Location",link:s+", "+h});u.map.setView(i);jQuery("#findYourForesterContainer").length>0?jQuery("#findYourForesterContainer").html(u.htmlPopupContents(r)):u.map.openPopup(L.popup({maxWidth:200,maxHeight:250}).setLatLng(i).setContent(u.htmlPopupContents(r)).openOn(u.map))},function(){console.log("error getting wms feature info")}),e};ProjectFirmaMaps.Map.prototype.carryOutPromises=function(n){var t=new jQuery.Deferred;return $.when.apply(jQuery,n).then(function(){t.resolve(Array.prototype.slice.call(arguments))},function(){t.fail(Array.prototype.slice.call(arguments))}),t};ProjectFirmaMaps.Map.prototype.removeDuplicatesFromArray=function(n,t){var u=[],r={};for(var i in n)r[n[i][t]]=n[i];for(i in r)u.push(r[i]);return u};ProjectFirmaMaps.Map.prototype.formatGeospatialAreaResponse=function(n){var u=new jQuery.Deferred,s,o;if(typeof n.features!="undefined"&&n.features.length>0){var t=n.features[0],e="",i="",r="",f="";switch(t.geometry_name){case"DNRUplandRegionLocation":e="/DNRUplandRegion/Detail/"+t.properties.DNRUplandRegionID;i=t.properties.DNRUplandRegionName;f="<a title='' href='"+e+"'>"+i+"<\/a>";r="DNR Upland Region";u.resolve({label:r,link:f});break;case"PriorityLandscapeLocation":e="/PriorityLandscape/Detail/"+t.properties.PriorityLandscapeID;i=t.properties.PriorityLandscapeName;f="<a title='' href='"+e+"'>"+i+"<\/a>";r="Priority Landscape";u.resolve({label:r,link:f});break;case"ProjectLocationGeometry":this.ProjectDetailedLocationSelectedLayerUrl&&(s={service:"WFS",version:"2.0",request:"GetFeature",outputFormat:"application/json",SrsName:"EPSG:4326",maxFeatures:1e4,typeNames:"WADNRForestHealth:ProjectLocationDetailed",cql_filter:"ProjectID="+t.properties.ProjectID},jQuery.ajax({url:this.ProjectDetailedLocationSelectedLayerUrl+L.Util.getParamString(s),dataType:"json"}).done(function(n){if(n.features.length>0)highlightOverlay=L.geoJSON(n,{style:{color:"#00FFFF",weight:2,opacity:.5}}),highlightOverlay.addTo(mapOutsideScope)}).fail(function(n){console.log(n)}));case"ProjectLocationPoint":queryUrl="/Project/ProjectMapPopup/"+t.properties.ProjectID;r="Project";o=[];o.push(jQuery.when(jQuery.ajax({url:queryUrl})).then(function(n){return n}));this.carryOutPromises(o).then(function(n){f=u.resolve({label:r,link:n[0]})},function(){console.log("error getting project popup info: "+queryUrl);u.resolve(null)});break;case"WashingtonCountyLocation":i=t.properties.WashingtonCountyFullName;r="Washington County";u.resolve({label:r,link:i});break;case"WashingtonLegislativeDistrictLocation":i=t.properties.WashingtonLegislativeDistrictName;r="Washington Legislative District";u.resolve({label:r,link:i});break;case"ForesterWorkUnitLocation":r=t.properties.ForesterRoleDisplayName;t.properties.ForesterRoleDefinition&&(r+=' <span tabindex="0" class="helpicon glyphicon glyphicon-question-sign" onmouseover="jQuery(this).popover(\'show\')" data-content="'+t.properties.ForesterRoleDefinition+'" data-html="true" data-toggle="popover" data-placement="top" data-trigger="hover focus"><\/span>');t.properties.FirstName?(i="<br/>"+t.properties.FirstName+" "+t.properties.LastName+"<br/>",t.properties.Phone&&(i+='<a href="tel:'+t.properties.Phone+'">'+t.properties.Phone+"<\/a> <br/>"),t.properties.Email&&(i+='<a href="mailto:'+t.properties.Email+'">'+t.properties.Email+"<\/a> <br/>")):i="<br/>This role is unassigned for this region.<br/>";u.resolve({label:r,link:i,properties:t.properties});break;default:console.log("layer not configured for feature info: "+t.geometry_name);u.resolve(null)}}else console.log("json object contains no features. unexpected wms response."),u.resolve(null);return u.promise()};