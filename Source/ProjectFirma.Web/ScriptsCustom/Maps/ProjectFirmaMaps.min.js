var ProjectFirmaMaps={};ProjectFirmaMaps.Map=function(n,t){var r=this,c,f,i,s;this.MapDivId=n.MapDivID;var l=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{}),a=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{}),v=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{}),h=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",{}),e={Aerial:l,Street:a,Terrain:v},o={"Street Labels":h},u;for(t==="Hybrid"?(u=new L.LayerGroup,t="Aerial",h.addTo(u)):(Sitka.Methods.isUndefinedNullOrEmpty(t)||e[t]==null)&&(t="Terrain"),c={scrollWheelZoom:!1,layers:[e[t]],attributionControl:!1,fullscreenControl:n.AllowFullScreen?{pseudoFullscreen:!0}:!1},this.map=L.map(this.MapDivId,c),u!=null&&u.addTo(this.map),this.vectorLayers=[],f=0;f<n.Layers.length;++f){i=n.Layers[f];switch(i.LayerType){case"Vector":this.addVectorLayer(i,o);break;case"Wms":this.addWmsLayer(i,o);break;default:console.error("Invalid LayerType "+i.LayerType+" not added to map layers.")}}if(this.addLayersToMapLayersControl(e,o),s=jQuery(".modal"),!Sitka.Methods.isUndefinedNullOrEmpty(s))s.on("shown.bs.modal",function(){r.map.invalidateSize();r.setMapBounds(n)});if(!n.DisablePopups)this.map.on("click",function(n){r.getFeatureInfo(n)});r.setMapBounds(n)};ProjectFirmaMaps.Map.prototype.addVectorLayer=function(n,t){var r=this,i=new L.LayerGroup,u=L.geoJson(n.GeoJsonFeatureCollection,{pointToLayer:function(t,i){var r=t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor;return L.marker(i,{icon:L.MakiMarkers.icon({icon:"marker",color:r,size:"s"})})},style:function(t){var i=_.includes(["Polygon","MultiPolygon"],t.geometry.type);return{color:t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor,weight:t.properties.FeatureWeight==null?2:t.properties.FeatureWeight,fill:t.properties.FillPolygon==null?i:t.properties.FillPolygon,fillOpacity:t.properties.FillOpacity==null?.2:t.properties.FillOpacity}},onEachFeature:function(n,t){r.bindPopupToFeature(t,n);r.bindHoverToFeature(t,n)}}).addTo(i);n.LayerInitialVisibility===1&&i.addTo(this.map);t[n.LayerName]=i;this.vectorLayers.push(u)};ProjectFirmaMaps.Map.prototype.addWmsLayer=function(n,t){var i=new L.LayerGroup,u=L.Util.extend(this.wmsParams,{layers:n.MapServerLayerName}),r=L.tileLayer.wms(n.MapServerUrl,u).addTo(i);n.LayerInitialVisibility===1&&i.addTo(this.map);r.on("click",function(n){self.getFeatureInfo(n)});t[n.LayerName]=i;this.vectorLayers.push(r)};ProjectFirmaMaps.Map.prototype.wmsParams={service:"WMS",transparent:!0,version:"1.1.1",format:"image/png",info_format:"application/json",tiled:!0};ProjectFirmaMaps.Map.prototype.wfsParams={service:"WFS",version:"2.0",request:"GetFeature",outputFormat:"application/json",SrsName:"EPSG:4326"};ProjectFirmaMaps.Map.prototype.addLayersToMapLayersControl=function(n,t){this.layerControl=L.control.layers(n,t);this.layerControl.addTo(this.map)};ProjectFirmaMaps.Map.prototype.setMapBounds=function(n){this.map.fitBounds([[n.BoundingBox.Northeast.Latitude,n.BoundingBox.Northeast.Longitude],[n.BoundingBox.Southwest.Latitude,n.BoundingBox.Southwest.Longitude]])};ProjectFirmaMaps.Map.prototype.bindPopupToFeature=function(n,t){var i=this;if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties.PopupUrl)){n.bindPopup("Loading...");n.on("click",function(r){i.map.setView(r.target.getLatLng());jQuery.get(t.properties.PopupUrl).done(function(t){n.bindPopup(t).openPopup({})})})}};ProjectFirmaMaps.Map.prototype.bindHoverToFeature=function(n,t){if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties["Hover Name"])){n.bindTooltip(t.properties["Hover Name"],{direction:"auto",sticky:"true"});var i=n.options.fillOpacity;n.on("mouseover",function(){n.setStyle({fillOpacity:Math.min(i+.4,1)})});n.on("mouseout",function(){n.setStyle({fillOpacity:i})})}return n};ProjectFirmaMaps.Map.prototype.assignClickEventHandler=function(n){for(var r,i=this,t=0;t<this.vectorLayers.length;++t){r=this.vectorLayers[t];r.on("click",function(t){n(i,t)})}this.map.on("click",function(t){n(i,t)})};ProjectFirmaMaps.Map.prototype.removeClickEventHandler=function(){for(var t,n=0;n<this.vectorLayers.length;++n)t=this.vectorLayers[n],t.off("click");this.map.off("click")};ProjectFirmaMaps.Map.prototype.formatLayerProperty=function(n,t){return Sitka.Methods.isUndefinedNullOrEmpty(t)&&(t="&nbsp"),"<span><strong>"+n+":<\/strong> "+t+"<\/span><\/br>"};ProjectFirmaMaps.Map.prototype.removeLayerFromMap=function(n){Sitka.Methods.isUndefinedNullOrEmpty(n)||this.map.removeLayer(n)};ProjectFirmaMaps.Map.prototype.addLayerToLayerControl=function(n,t){this.layerControl.addOverlay(n,t)};ProjectFirmaMaps.Map.prototype.disableUserInteraction=function(){this.map.dragging.disable();this.map.touchZoom.disable();this.map.doubleClickZoom.disable();this.map.scrollWheelZoom.disable();this.map.boxZoom.disable();this.map.keyboard.disable();this.map.attributionControl=!1;this.map.tap&&this.map.tap.disable();document.getElementById(this.MapDivId).style.cursor="default";jQuery(".leaflet-control-zoom").css("visibility","hidden");jQuery(".leaflet-control-layers").css("visibility","hidden");this.removeClickEventHandler()};ProjectFirmaMaps.Map.prototype.blockMapImpl=function(){this.map.dragging.disable();this.map.scrollWheelZoom.disable();jQuery("#"+this.MapDivId).block({message:"<span style='font-weight: bold; font-size: 14px; margin: 0 2px'>Location Not Specified<\/span>",css:{border:"none",cursor:"default"},overlayCSS:{backgroundColor:"#D3D3D3",cursor:"default"},baseZ:999})};ProjectFirmaMaps.Map.prototype.blockMap=function(){var t=this,n;this.blockMapImpl();n=jQuery(".modal");n.on("shown.bs.modal",function(){t.blockMapImpl()})};ProjectFirmaMaps.Map.prototype.unblockMap=function(){this.map.dragging.enable();jQuery("#"+this.MapDivId).unblock()};ProjectFirmaMaps.Map.prototype.getFeatureInfo=function(n){var t=n.latlng,i=this,r=this.vectorLayers.filter(function(n){return n.hasOwnProperty("wmsParams")&&i.map.hasLayer(n)}),u=this.vectorLayers.filter(function(n){return!n.hasOwnProperty("wmsParams")&&i.map.hasLayer(n)});r.length>0?this.popupForWMSAndVectorLayers(r,u,t):this.popupForVectorLayers(u,t)};ProjectFirmaMaps.Map.prototype.popupForVectorLayers=function(n,t){for(var u,f,e,o,i=[],r=0;r<n.length;++r)u=n[r],f=this.getVectorLayerInfoHtmlForPopup(u,t),i.push(f);e=L.Util.formatNum(t.lat,4);o=L.Util.formatNum(t.lng,4);i.push({label:"Location",link:e+", "+o});this.map.setView(t);this.map.openPopup(L.popup({maxWidth:200}).setLatLng(t).setContent(this.htmlPopupContents(i)).openOn(this.map))};ProjectFirmaMaps.Map.prototype.htmlPopupContents=function(n){var i=this,r=this.removeDuplicatesFromArray(n,"label"),t="<div>";return _.forEach(r,function(n){n.label!=null&&(t+=i.formatLayerProperty(n.label,n.link))}),t+="<\/div>"};ProjectFirmaMaps.Map.prototype.getVectorLayerInfoHtmlForPopup=function(n,t){for(var i,u=null,f=null,e=leafletPip.pointInLayer(t,n,!0),o=_(e).map(function(n){return _.keys(n.feature.properties)}).flatten().uniq().map(function(n){return{key:n,values:_(e).map(function(t){return t.feature.properties[n]}).filter().value()}}).value(),r=0;r<o.length;r++)i=o[r],i.key!=="Hover Name"&&(u=i.values.length>1?i.key+"s":i.key,f=i.values.join(", "));return{label:u,link:f}};ProjectFirmaMaps.Map.prototype.popupForWMSAndVectorLayers=function(n,t,i){var r=this,o=this.map.latLngToContainerPoint(i,this.map.getZoom()),s=this.map.getSize(),f={service:"WMS",version:"1.1.1",request:"GetFeatureInfo",layers:null,styles:"",srs:"EPSG:4326",bbox:this.map.getBounds().toBBoxString(),height:s.y,width:s.x,query_layers:null,info_format:"application/json"},e,u,h,c;for(f.x=o.x,f.y=o.y,e=[],u=0;u<n.length;++u)h=n[u],f.layers=n[u].wmsParams.layers,f.query_layers=n[u].wmsParams.layers,c=h._url+L.Util.getParamString(f,null,!0),e.push(jQuery.when(jQuery.ajax({url:c})).then(function(n){return r.formatGeospatialAreaResponse(n).then(function(n){return n})}));this.carryOutPromises(e).then(function(n){for(var e,o,s,h,u=[],f=0;f<t.length;++f)e=t[f],o=r.getVectorLayerInfoHtmlForPopup(e,i),u.push(o);_.forEach(n,function(n){n!=null&&u.push(n)});s=L.Util.formatNum(i.lat,4);h=L.Util.formatNum(i.lng,4);u.push({label:"Location",link:s+", "+h});r.map.setView(i);r.map.openPopup(L.popup({maxWidth:200}).setLatLng(i).setContent(r.htmlPopupContents(u)).openOn(r.map))},function(){console.log("error getting wms feature info")})};ProjectFirmaMaps.Map.prototype.carryOutPromises=function(n){var t=new jQuery.Deferred;return $.when.apply(jQuery,n).then(function(){t.resolve(Array.prototype.slice.call(arguments))},function(){t.fail(Array.prototype.slice.call(arguments))}),t};ProjectFirmaMaps.Map.prototype.removeDuplicatesFromArray=function(n,t){var u=[],r={};for(var i in n)r[n[i][t]]=n[i];for(i in r)u.push(r[i]);return u};ProjectFirmaMaps.Map.prototype.formatGeospatialAreaResponse=function(n){var t=new jQuery.Deferred,o;if(typeof n.features!="undefined"&&n.features.length>0){var i=n.features[0],f="",e="",r="",u="";switch(i.geometry_name){case"RegionLocation":f="/Region/Detail/"+i.properties.RegionID;e=i.properties.RegionName;u="<a title='' href='"+f+"'>"+e+"<\/a>";r="Region";t.resolve({label:r,link:u});break;case"PriorityAreaLocation":f="/PriorityArea/Detail/"+i.properties.PriorityAreaID;e=i.properties.PriorityAreaName;u="<a title='' href='"+f+"'>"+e+"<\/a>";r="Priority Area";t.resolve({label:r,link:u});break;case"ProjectLocationGeometry":case"ProjectLocationPoint":queryUrl="/Project/ProjectMapPopup/"+i.properties.ProjectID;r="Project";o=[];o.push(jQuery.when(jQuery.ajax({url:queryUrl})).then(function(n){return n}));this.carryOutPromises(o).then(function(n){u=t.resolve({label:r,link:n[0]})},function(){console.log("error getting project popup info: "+queryUrl);t.resolve(null)});break;default:console.log("layer not configured for feature info: "+i.geometry_name);t.resolve(null)}}else console.log("json object contains no features. unexpected wms response."),t.resolve(null);return t.promise()};